image: "rust:latest"

services:
  - postgres:10

variables:
  POSTGRES_DB: fetch_test
  POSTGRES_USER: fetch
  POSTGRES_PASSWORD: "adfjkv389gqyh39gheilfgeuj"


stages:
  - test
  - style
  - deploy

cargo:
  stage: test
  before_script:
    - apt-get update -yqq
    - apt-get install -yqq --no-install-recommends build-essential libclang-dev libpq-dev
  script:
    - du -hs target || true
    - du -hs cargo || true
    - rustc --version && cargo --version && rustup --version
    - CARGO_HOME=$CI_PROJECT_DIR/cargo cargo install diesel_cli --no-default-features --features postgres --force
    - echo "DATABASE_URL=postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres/${POSTGRES_DB}" > .env
    - cat .env
    - $CI_PROJECT_DIR/cargo/bin/diesel migration run
    - CARGO_HOME=$CI_PROJECT_DIR/cargo cargo build --verbose --release
    - CARGO_HOME=$CI_PROJECT_DIR/cargo cargo test --verbose --jobs 1 --release
  cache:
    paths:
      - target/
      - cargo/

npm:
  stage: test
  image: node:8
  script:
    - du -hs node_modules || true
    - node --version && npm --version
    - npm install
    - npm run build
  cache:
    paths:
      - node_modules/

rustfmt:
  stage: style
  allow_failure: true
  script:
    - rustc --version && cargo --version && rustup --version
    - rustup component add rustfmt-preview
    - rustfmt --write-mode diff src/backend/**.rs

pages:
  stage: deploy
  script:
    - du -hs cargo || true
    - rustc --version && cargo --version && rustup --version
    - CARGO_HOME=$CI_PROJECT_DIR/cargo cargo doc
    - rm -rf public
    - mv target/doc public
    - echo "<meta http-equiv=refresh content=1;url=fetch_rs/index.html>" > public/index.html
  cache:
    paths:
      - cargo/
  artifacts:
    paths:
    - public
  only:
    - master

