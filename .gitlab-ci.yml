image: "rust:1.23"

services:
  - postgres:10

variables:
  POSTGRES_DB: fetch_test
  POSTGRES_USER: fetch
  POSTGRES_PASSWORD: ""

before_script:
  - apt-get update -yqq
  - apt-get install -yqq --no-install-recommends build-essential libclang-dev libpq-dev

stages:
  - test
  - style
  - deploy

cargo:
  stage: test
  script:
    - rustc --version && cargo --version && rustup --version
    - cargo install diesel_cli --no-default-features --features postgres 
    - echo "DATABASE_URL=postgres://${POSTGRES_USER}@postgres/${POSTGRES_DB}" > .env
    - cat .env
    - diesel migration run
    - cargo build --verbose --release
    - cargo test --verbose --jobs 1 --release

rustfmt:
  stage: style
  allow_failure: true
  script:
    - rustc --version && cargo --version && rustup --version
    - rustup component add rustfmt-preview
    - rustfmt --write-mode diff src/**.rs

pages:
  stage: deploy
  script:
    - rustc --version && cargo --version && rustup --version
    - cargo doc
    - rm -rf public
    - mv target/doc public
    - echo "<meta http-equiv=refresh content=1;url=fetch-rs/index.html>" > public/index.html
  artifacts:
    paths:
    - public
  only:
    - master

